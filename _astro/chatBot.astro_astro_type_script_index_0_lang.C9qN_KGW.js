document.addEventListener("DOMContentLoaded",async()=>{const d=document.querySelector(".btn-chatbot"),m=document.querySelector(".contenedor-chatbot"),b=document.querySelector(".close-button-chat-bot"),i=document.querySelector(".chat-dinamico"),r=document.querySelector(".chat-bot"),l=document.querySelector("#input-mensaje-chat-bot"),g=document.querySelector("#button-enviar-msj");async function p(){try{const e=localStorage.getItem("conversationId");if(e)return console.log("ID de conversación recuperado del almacenamiento local:",e),e;const a=await(await fetch("https://bot.flexglobal.mosquedacordova.com/api/conversation-configurations",{method:"POST"})).json();if(a.status==="success"){const n=a.data.id;return console.log("Nuevo ID de conversación creado:",n),localStorage.setItem("conversationId",n),n}else return console.error("Error al obtener el ID de la conversación:",a.message),null}catch(e){return console.error("Error al obtener el ID de la conversación:",e),null}}async function v(){try{const e=await p(),a=await(await fetch(`https://bot.flexglobal.mosquedacordova.com/api/consultar-conversacion/${e}`)).json();if(a.status==="success"){const n=a.data;i.innerHTML="",n.forEach(o=>{const t=document.createElement("div");if(o.role==="system")if(t.className="our-msj p-3 bg-light text-dark rounded-3 border",o.type==="interactive"&&o.message.includes("(btn\\")){console.log("Mensaje con botones interactivos detectado:",o.message);const s=y(o.message);t.appendChild(s)}else t.textContent=o.message;else if(o.role==="user"){const s=document.createElement("div");s.className="d-flex justify-content-end",t.className="your-msj bg-dark text-white p-3 rounded-3",t.textContent=o.message,s.appendChild(t),i.appendChild(s);return}i.appendChild(t)}),r.scrollTop=r.scrollHeight}}catch(e){console.error("Error fetching messages:",e)}}async function h(e,c,a="Título no definido"){try{const o={message:{from:await p(),type:e},source:"PopUp"};e==="text"?o.message.text=c:e==="interactive"&&(o.interactive={id:c,title:a});const t=await fetch("https://bot.flexglobal.mosquedacordova.com/api/webhook/popup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),s=await t.json();if(console.log("Respuesta de la API:",s),t.status===200&&s.status==="success")v(),console.log("El mensaje fue recibido y procesado correctamente:",s.message);else{console.error("Error al procesar el mensaje:",s.message||"Error desconocido.");const u=document.createElement("div");u.className="our-msj p-3 bg-light text-dark rounded-3 border",u.textContent="Hubo un error al procesar tu mensaje. Por favor, intenta nuevamente.",i.appendChild(u),r.scrollTop=r.scrollHeight}}catch(n){console.error("Error al enviar el mensaje:",n)}}async function f(){const e=l.value.trim();if(e===""){console.log("El mensaje no puede estar vacío.");return}if(/<script|<\/script>|onerror|onload|javascript:|eval|alert|document\.cookie|<iframe|<img|<svg|<link|<style|<meta|<object|<embed|<form|<input|<textarea|<button|<select|<option|<a|<base|<body|<head|<html|<title|<video|<audio|<source|<track|<canvas|<map|<area|<frame|<frameset|<noframes|<applet|<bgsound|<blink|<marquee|<isindex|<plaintext|<xmp/i.test(e)){console.log("El mensaje contiene contenido malicioso y no puede ser enviado.");return}l.value="";const a=document.createElement("div"),n=document.createElement("div");n.className="d-flex justify-content-end",a.className="your-msj bg-dark text-white p-3 rounded-3",a.textContent=e,n.appendChild(a),i.appendChild(n),r.scrollTop=r.scrollHeight,await h("text",e)}function y(e){const c=document.createElement("div");c.className="d-flex flex-column gap-2";const a=/\(btn\\id:(\d+)->(.*?)\/btn\)/g;let n=0,o;for(;(o=a.exec(e))!==null;){if(o.index>n){const s=e.slice(n,o.index);c.appendChild(document.createTextNode(s))}const t=document.createElement("button");t.textContent=o[2],t.className="btn btn-primary btn-sm mx-1",t.dataset.id=o[1],t.addEventListener("click",async()=>{console.log("Botón presionado con id:",t.dataset.id),await h("interactive",t.dataset.id,t.textContent)}),c.appendChild(t),n=a.lastIndex}return c}d.addEventListener("click",async()=>{d.classList.add("d-none"),m.classList.remove("d-none"),v()}),b.addEventListener("click",()=>{m.classList.add("d-none"),d.classList.remove("d-none")}),g.addEventListener("click",f),l.addEventListener("keypress",e=>{e.key==="Enter"&&f()})});
